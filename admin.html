<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Admin - NexaDriveMotors</title>
  <link rel="stylesheet" href="css/styles.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    .admin-container { max-width: 1200px; margin: 2rem auto; padding: 2rem; }
    .admin-header { margin-bottom: 2rem; }
    .admin-tabs { display: flex; gap: 1rem; margin-bottom: 2rem; border-bottom: 2px solid #eee; }
    .admin-tab { padding: 1rem 2rem; background: none; border: none; cursor: pointer; font-size: 1rem; font-weight: 500; color: #666; transition: all 0.3s; }
    .admin-tab.active { color: #3498db; border-bottom: 2px solid #3498db; margin-bottom: -2px; }
    .admin-panel { display: none; }
    .admin-panel.active { display: block; }
    .form-group { margin-bottom: 1.5rem; }
    .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 5px; font-size: 1rem; }
    .form-group textarea { min-height: 100px; resize: vertical; }
    .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
    .vehicle-list { display: grid; gap: 1rem; }
    .vehicle-item { background: white; padding: 1rem; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
    .vehicle-actions { display: flex; gap: 0.5rem; }
    .btn-small { padding: 0.5rem 1rem; font-size: 0.9rem; }
    .auth-form { max-width: 400px; margin: 4rem auto; padding: 2rem; background: white; border-radius: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
    .hidden { display: none !important; }
    .status-message { padding: 1rem; margin-bottom: 1rem; border-radius: 5px; }
    .status-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .status-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="nav-container">
      <h2>NexaDriveMotors - Admin</h2>
      <button class="btn btn-outline" onclick="logout()">Logout</button>
    </div>
  </nav>

  <!-- Auth Form -->
  <div id="auth-section" class="auth-form">
    <h2>Admin Login</h2>
    <div class="form-group">
      <label>Admin Password</label>
      <input type="password" id="admin-password" placeholder="Enter admin password">
    </div>
    <button class="btn btn-primary" onclick="login()">Login</button>
    <p style="margin-top: 1rem; font-size: 0.9rem; color: #666;">Default password: admin123</p>
  </div>

  <!-- Admin Panel -->
  <div id="admin-section" class="admin-container hidden">
    <div class="admin-header">
      <h1>Vehicle Management</h1>
      <p>Manage your inventory, upload images, and update listings</p>
    </div>

    <div class="admin-tabs">
      <button class="admin-tab active" onclick="switchTab('list')">Vehicle List</button>
      <button class="admin-tab" onclick="switchTab('add')">Add New Vehicle</button>
      <button class="admin-tab" onclick="switchTab('upload')">Upload Images</button>
    </div>

    <div id="status-message"></div>

    <!-- List Panel -->
    <div id="list-panel" class="admin-panel active">
      <h2>Current Inventory</h2>
      <div id="vehicle-list" class="vehicle-list">
        <p>Loading vehicles...</p>
      </div>
    </div>

    <!-- Add/Edit Panel -->
    <div id="add-panel" class="admin-panel">
      <h2 id="form-title">Add New Vehicle</h2>
      <form id="vehicle-form">
        <input type="hidden" id="vehicle-id">
        <div class="form-row">
          <div class="form-group">
            <label>Title *</label>
            <input type="text" id="title" required placeholder="2023 BMW X5">
          </div>
          <div class="form-group">
            <label>Make *</label>
            <input type="text" id="make" required placeholder="bmw">
          </div>
          <div class="form-group">
            <label>Model *</label>
            <input type="text" id="model" required placeholder="X5">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Year *</label>
            <input type="number" id="year" required placeholder="2023" min="1900" max="2030">
          </div>
          <div class="form-group">
            <label>Price *</label>
            <input type="number" id="price" required placeholder="45999" min="0">
          </div>
          <div class="form-group">
            <label>Mileage *</label>
            <input type="number" id="mileage" required placeholder="15000" min="0">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Fuel Type *</label>
            <select id="fuel" required>
              <option value="">Select...</option>
              <option value="gasoline">Gasoline</option>
              <option value="diesel">Diesel</option>
              <option value="hybrid">Hybrid</option>
              <option value="electric">Electric</option>
            </select>
          </div>
          <div class="form-group">
            <label>Transmission *</label>
            <select id="transmission" required>
              <option value="">Select...</option>
              <option value="automatic">Automatic</option>
              <option value="manual">Manual</option>
              <option value="cvt">CVT</option>
            </select>
          </div>
          <div class="form-group">
            <label>Featured</label>
            <select id="featured">
              <option value="0">No</option>
              <option value="1">Yes</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label>Description</label>
          <textarea id="description" placeholder="Detailed vehicle description..."></textarea>
        </div>

        <div class="form-group">
          <label>Features (comma-separated)</label>
          <input type="text" id="features" placeholder="AWD, Leather, Sunroof, Navigation">
        </div>

        <div class="form-group">
          <label>Images (comma-separated paths)</label>
          <input type="text" id="images" placeholder="images/car1.jpg, images/car2.jpg">
        </div>

        <div style="display: flex; gap: 1rem;">
          <button type="submit" class="btn btn-primary">Save Vehicle</button>
          <button type="button" class="btn btn-outline" onclick="resetForm()">Cancel</button>
        </div>
      </form>
    </div>

    <!-- Upload Panel -->
    <div id="upload-panel" class="admin-panel">
      <h2>Upload Vehicle Images</h2>
      <div class="form-group">
        <label>Select Image</label>
        <input type="file" id="image-upload" accept="image/jpeg,image/jpg,image/png">
      </div>
      <button class="btn btn-primary" onclick="uploadImage()">Upload</button>
      <div id="upload-result" style="margin-top: 1rem;"></div>
    </div>
  </div>

  <script>
    let adminPass = '';

    function login() {
      adminPass = document.getElementById('admin-password').value;
      if (!adminPass) {
        alert('Please enter password');
        return;
      }
      document.getElementById('auth-section').classList.add('hidden');
      document.getElementById('admin-section').classList.remove('hidden');
      loadVehicles();
    }

    function logout() {
      adminPass = '';
      document.getElementById('auth-section').classList.remove('hidden');
      document.getElementById('admin-section').classList.add('hidden');
      document.getElementById('admin-password').value = '';
    }

    function switchTab(tab) {
      document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.admin-panel').forEach(p => p.classList.remove('active'));
      
      event.target.classList.add('active');
      document.getElementById(tab + '-panel').classList.add('active');
      
      if (tab === 'list') loadVehicles();
    }

    async function loadVehicles() {
      try {
        const res = await fetch('/api/vehicles');
        const vehicles = await res.json();
        
        const list = document.getElementById('vehicle-list');
        if (vehicles.length === 0) {
          list.innerHTML = '<p>No vehicles found.</p>';
          return;
        }
        
        list.innerHTML = vehicles.map(v => `
          <div class="vehicle-item">
            <div>
              <strong>${v.title}</strong> - $${v.price.toLocaleString()}
              <br><small>${v.make} | ${v.year} | ${v.mileage.toLocaleString()} miles</small>
            </div>
            <div class="vehicle-actions">
              <button class="btn btn-small btn-primary" onclick="editVehicle(${v.id})">Edit</button>
              <button class="btn btn-small btn-outline" onclick="deleteVehicle(${v.id})">Delete</button>
            </div>
          </div>
        `).join('');
      } catch (err) {
        showStatus('Failed to load vehicles', 'error');
      }
    }

    async function editVehicle(id) {
      try {
        const res = await fetch(`/api/vehicles/${id}`);
        const v = await res.json();
        
        document.getElementById('vehicle-id').value = v.id;
        document.getElementById('title').value = v.title;
        document.getElementById('make').value = v.make;
        document.getElementById('model').value = v.model;
        document.getElementById('year').value = v.year;
        document.getElementById('price').value = v.price;
        document.getElementById('mileage').value = v.mileage;
        document.getElementById('fuel').value = v.fuel;
        document.getElementById('transmission').value = v.transmission;
        document.getElementById('featured').value = v.featured ? '1' : '0';
        document.getElementById('description').value = v.description || '';
        document.getElementById('features').value = (v.features || []).join(', ');
        document.getElementById('images').value = (v.images || []).join(', ');
        
        document.getElementById('form-title').textContent = 'Edit Vehicle';
        switchTab('add');
        document.querySelectorAll('.admin-tab')[1].click();
      } catch (err) {
        showStatus('Failed to load vehicle', 'error');
      }
    }

    async function deleteVehicle(id) {
      if (!confirm('Are you sure you want to delete this vehicle?')) return;
      
      try {
        const res = await fetch(`/api/vehicles/${id}`, {
          method: 'DELETE',
          headers: { 'x-admin-pass': adminPass }
        });
        
        if (res.ok) {
          showStatus('Vehicle deleted successfully', 'success');
          loadVehicles();
        } else {
          showStatus('Failed to delete vehicle', 'error');
        }
      } catch (err) {
        showStatus('Error: ' + err.message, 'error');
      }
    }

    document.getElementById('vehicle-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const id = document.getElementById('vehicle-id').value;
      const data = {
        title: document.getElementById('title').value,
        make: document.getElementById('make').value,
        model: document.getElementById('model').value,
        year: parseInt(document.getElementById('year').value),
        price: parseInt(document.getElementById('price').value),
        mileage: parseInt(document.getElementById('mileage').value),
        fuel: document.getElementById('fuel').value,
        transmission: document.getElementById('transmission').value,
        featured: document.getElementById('featured').value === '1',
        description: document.getElementById('description').value,
        features: document.getElementById('features').value.split(',').map(f => f.trim()).filter(f => f),
        images: document.getElementById('images').value.split(',').map(i => i.trim()).filter(i => i)
      };
      
      try {
        const url = id ? `/api/vehicles/${id}` : '/api/vehicles';
        const method = id ? 'PUT' : 'POST';
        
        const res = await fetch(url, {
          method,
          headers: {
            'Content-Type': 'application/json',
            'x-admin-pass': adminPass
          },
          body: JSON.stringify(data)
        });
        
        if (res.ok) {
          showStatus(id ? 'Vehicle updated successfully' : 'Vehicle created successfully', 'success');
          resetForm();
          switchTab('list');
          document.querySelectorAll('.admin-tab')[0].click();
        } else {
          const error = await res.json();
          showStatus(error.error || 'Failed to save vehicle', 'error');
        }
      } catch (err) {
        showStatus('Error: ' + err.message, 'error');
      }
    });

    function resetForm() {
      document.getElementById('vehicle-form').reset();
      document.getElementById('vehicle-id').value = '';
      document.getElementById('form-title').textContent = 'Add New Vehicle';
    }

    async function uploadImage() {
      const input = document.getElementById('image-upload');
      const file = input.files[0];
      
      if (!file) {
        alert('Please select an image');
        return;
      }
      
      const formData = new FormData();
      formData.append('image', file);
      
      try {
        const res = await fetch('/api/uploads/images', {
          method: 'POST',
          headers: { 'x-admin-pass': adminPass },
          body: formData
        });
        
        if (res.ok) {
          const result = await res.json();
          document.getElementById('upload-result').innerHTML = `
            <div class="status-success">
              Image uploaded successfully!<br>
              Path: <code>${result.path}</code>
            </div>
          `;
          input.value = '';
        } else {
          const error = await res.json();
          document.getElementById('upload-result').innerHTML = `
            <div class="status-error">${error.error || 'Upload failed'}</div>
          `;
        }
      } catch (err) {
        document.getElementById('upload-result').innerHTML = `
          <div class="status-error">Error: ${err.message}</div>
        `;
      }
    }

    function showStatus(message, type) {
      const el = document.getElementById('status-message');
      el.innerHTML = `<div class="status-${type}">${message}</div>`;
      setTimeout(() => el.innerHTML = '', 5000);
    }
  </script>
</body>
</html>